esphome:
  name: entrance_lock
  platform: ESP8266
  board: d1_mini_pro

  includes:
    - d1motor.h

  # XXX
  arduino_version: dev

substitutions:
  uname: Entrance Lock

wifi:
  networks: !secret wifi_networks

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "${uname} Fallback Hotspot"
    password: !secret wifi_ap_passwd

captive_portal:

# Enable logging
logger:

debug:

# Enable Home Assistant API
api:
  password: !secret api_password
  reboot_timeout: 5min
  services:
    - service: lock
      then:
        - logger.log: "requested to lock"

    - service: unlock
      then:
        - logger.log: "requested to unlock"

ota:
  password: !secret ota_password

web_server:
  auth:
    username: admin
    password: !secret web_password

prometheus:

i2c:
  id: i2c_bus
  scl: D1
  sda: D2

time:
  - platform: homeassistant
    id: esp_time
  - platform: sntp
    id: ntp_time
    timezone: Europe/Moscow

globals:
  - id: gv_lock_cnt
    type: uint32_t
    restore_value: yes
    initial_value: '0'
  - id: gv_unlock_cnt
    type: uint32_t
    restore_value: yes
    initial_value: '0'

# custom_component:
#   - id: lock_motor
#     lambda: |-
#       auto motor = new D1Motor(id(i2c_bus), 0x30, 0);
#       return {motor};

output:
  - platform: custom
    type: float
    lambda: |-
      auto lock_motor_output = new D1Motor(id(i2c_bus), 0x30, 0);
      App.register_component(lock_motor_output);
      return {lock_motor_output};

    outputs:
      id: lock_motor

text_sensor:
  - platform: wifi_info
    ssid:
      name: $uname SSID
    bssid:
      name: $uname BSSID

  - platform: version
    name: "$uname ESPHome version"

binary_sensor:
  - platform: status
    name: $uname Connected

  - platform: gpio
    pin:
      number: D5
      mode: INPUT_PULLUP
      inverted: true
    filters:
      - delayed_on_off: 10ms
    id: h_closed
    name: $uname Door Closed
    device_class: door

  - platform: gpio
    pin:
      number: D6
      mode: INPUT_PULLUP
      inverted: true
    filters:
      - delayed_on_off: 10ms
    id: h_locked
    name: $uname Locked endstop

  - platform: gpio
    pin:
      number: D7
      mode: INPUT_PULLUP
      inverted: true
    filters:
      - delayed_on_off: 10ms
    id: h_unlocked
    name: $uname Unlocked endstop

  - platform: gpio
    pin:
      number: D3
      mode: INPUT_PULLUP
      inverted: true
    filters:
      - delayed_on_off: 10ms
    id: btn_ext_open
    name: $uname External Open

    on_press:
      - lambda: |-
          auto m = static_cast<D1Motor*>(id(lock_motor));
          m->set_level(-1.0f);

    on_release:
      - lambda: |-
          auto m = static_cast<D1Motor*>(id(lock_motor));
          //m->set_level(0.0f);
          m->set_level(NAN);

  - platform: gpio
    pin:
      number: D4
      mode: INPUT_PULLUP
      inverted: true
    filters:
      - delayed_on_off: 10ms
    id: btn_int_open
    name: $uname Internal Open

    on_press:
      - lambda: |-
          auto m = static_cast<D1Motor*>(id(lock_motor));
          m->set_level(1.0f);

    on_release:
      - lambda: |-
          auto m = static_cast<D1Motor*>(id(lock_motor));
          //m->set_level(0.0f);
          m->set_level(INFINITY);


sensor:
  - platform: wifi_signal
    name: "$uname WiFi Signal"
    update_interval: 10s

  - platform: uptime
    name: "$uname Uptime"

switch:
  - platform: restart
    name: $uname Reboot

  #- platform: template
  #  name: $uname
  #  device_class: lock
