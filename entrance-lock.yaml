esphome:
  name: entrance_lock
  platform: ESP8266
  board: d1_mini_pro

wifi:
  networks: !secret wifi_networks

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Entrance Lock Fallback Hotspot"
    password: !secret wifi_ap_passwd

captive_portal:

# Enable logging
logger:

debug:

# Enable Home Assistant API
api:
  password: !secret api_password
  reboot_timeout: 5min
  services:
    - service: lock
      then:
        - logger.log: "requested to lock"

    - service: unlock
      then:
        - logger.log: "requested to unlock"

ota:
  password: !secret ota_password

web_server:
  prometheus: true
  auth:
    username: admin
    password: !secret web_password

i2c:
  scl: D1
  sda: D2

time:
  - platform: homeassistant
    id: esp_time
  - platform: sntp
    id: ntp_time
    timezone: Europe/Moscow

globals:
  - id: gv_lock_cnt
    type: uint32_t
    restore_value: yes
    initial_value: '0'
  - id: gv_unlock_cnt
    type: uint32_t
    restore_value: yes
    initial_value: '0'

text_sensor:
  - platform: wifi_info
    ssid:
      name: Entrance Lock SSID
    bssid:
      name: Entrance Lock BSSID

  - platform: version
    name: "ESPHome version"

binary_sensor:
  - platform: status
    name: Entrance Lock Connected

  - platform: gpio
    pin:
      number: D5
      mode: INPUT_PULLUP
      inverted: true
    filters:
      - delayed_on_off: 10ms
    id: h_closed
    name: Entrance Gate Closed
    device_class: door

  - platform: gpio
    pin:
      number: D6
      mode: INPUT_PULLUP
      inverted: true
    filters:
      - delayed_on_off: 10ms
    id: h_locked
    name: Entrance Gate Locked endstop

  - platform: gpio
    pin:
      number: D7
      mode: INPUT_PULLUP
      inverted: true
    filters:
      - delayed_on_off: 10ms
    id: h_unlocked
    name: Entrance Gate Unlocked endstop

  - platform: gpio
    pin:
      number: D3
      mode: INPUT_PULLUP
      inverted: true
    filters:
      - delayed_on_off: 10ms
    id: btn_ext_open
    name: Entrance Gate External Open

  - platform: gpio
    pin:
      number: D4
      mode: INPUT_PULLUP
      inverted: true
    filters:
      - delayed_on_off: 10ms
    id: btn_int_open
    name: Entrance Gate Internal Open

sensor:
  - platform: wifi_signal
    name: "Entrance Lock WiFi Signal"
    update_interval: 10s

  - platform: uptime
    name: "Entrance Lock Uptime"

switch:
  - platform: restart
    name: Entrance Lock Reboot

  - platform: template
    name: Entrance Lock
    device_class: lock
